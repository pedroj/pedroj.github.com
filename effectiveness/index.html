<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Effectiveness: This is the page for the code to estimate effectivenss landscapes of plant-animal interactions" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

	<style type="text/css">
	body, td {
	   font-family: sans-serif;
	   background-color: white;
	   font-size: 14px;
	   margin: 8px;
	}

	tt, code, pre {
	   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
	}

	h1 { 
	   font-size:2.2em; 
	}

	h2 { 
	   font-size:1.8em; 
	}

	h3 { 
	   font-size:1.4em; 
	}

	h4 { 
	   font-size:1.0em; 
	}

	h5 { 
	   font-size:0.9em; 
	}

	h6 { 
	   font-size:0.8em; 
	}

	a:visited {
	   color: rgb(50%, 0%, 50%);
	}

	pre {	
	   margin-top: 0;
	   max-width: 95%;
	   border: 1px solid #ccc;
	   white-space: pre-wrap;
	}

	pre code {
	   display: block; padding: 0.5em;
	}

	code.r, code.cpp {
	   background-color: #F8F8F8;
	}

	table, td, th {
	  border: none;
	}

	blockquote {
	   color:#666666;
	   margin:0;
	   padding-left: 1em;
	   border-left: 0.5em #EEE solid;
	}

	hr {
	   height: 0px;
	   border-bottom: none;
	   border-top-width: thin;
	   border-top-style: dotted;
	   border-top-color: #999999;
	}

	@media print {
	   * { 
	      background: transparent !important; 
	      color: black !important; 
	      filter:none !important; 
	      -ms-filter: none !important; 
	   }

	   body { 
	      font-size:12pt; 
	      max-width:100%; 
	   }
       
	   a, a:visited { 
	      text-decoration: underline; 
	   }

	   hr { 
	      visibility: hidden;
	      page-break-before: always;
	   }

	   pre, blockquote { 
	      padding-right: 1em; 
	      page-break-inside: avoid; 
	   }

	   tr, img { 
	      page-break-inside: avoid; 
	   }

	   img { 
	      max-width: 100% !important; 
	   }

	   @page :left { 
	      margin: 15mm 20mm 15mm 10mm; 
	   }
     
	   @page :right { 
	      margin: 15mm 10mm 15mm 20mm; 
	   }

	   p, h2, h3 { 
	      orphans: 3; widows: 3; 
	   }

	   h2, h3 { 
	      page-break-after: avoid; 
	   }
	}

	</style>

	<!-- Styles for R syntax highlighter -->
	<style type="text/css">
	   pre .operator,
	   pre .paren {
	     color: rgb(104, 118, 135)
	   }

	   pre .literal {
	     color: rgb(88, 72, 246)
	   }

	   pre .number {
	     color: rgb(0, 0, 205);
	   }

	   pre .comment {
	     color: rgb(76, 136, 107);
	   }

	   pre .keyword {
	     color: rgb(0, 0, 255);
	   }

	   pre .identifier {
	     color: rgb(0, 0, 0);
	   }

	   pre .string {
	     color: rgb(3, 106, 7);
	   }
	</style>

	<!-- R syntax highlighter -->
<!-- R syntax highlighter -->
<link rel="stylesheet" href="stylesheets/styles/xcode.css">
<script src="javascripts/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-------------------------->
	</script>

<!------------------------------------------------------------------------------------------------>
    <title>Effectiveness</title>
  </head>

  <body>

<!-- HEADER -->
   <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/pedroj/effectiveness_pckg">View on GitHub</a>

          <h1 id="project_title">Effectiveness</h1>
          <h2 id="project_tagline">An R package for plots of effectiveness landscapes in mutualisms (seed dispersal, pollination)</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/pedroj/effectiveness_pckg/zipball/master">Download this project as a .zip file</a> 
              <a class="tar_download_link" href="https://github.com/pedroj/effectiveness_pckg/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

<!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
<h3>Plotting effectiveness landscapes.</h3>

<p>Effectiveness landscapes are the two-dimensional representation of the possible combinations of the quantity and the quality of dualistic services (seed dispersal, pollination) and with elevational contours representing isoclines of effectiveness. These representations can be 2D bivariate plots of multiplicative effects of any of the seed dispersal (SDE) or pollination (PE) effectiveness components. For example, SDE can be quantified as the number of seeds dispersed by a dispersal agent multiplied by the probability that a dispersed seed produces a new adult: SDE = Quantity · Quality. Quantity and quality in turn are each determined by two subcomponents. Quantity is (1) the number of visits a dispersal agent makes multiplied by (2) the number of seeds dispersed per visit, while quality is (1) the probability that a dispersed seed survives handling by the dispersal agent in a viable condition (quality of treatment in the mouth and gut) multiplied by (2) the probability that a viable dispersed seed will survive, germinate, and produce a new adult (quality of deposition).
Thus the SDE landscape can be any 2D plot of Qty x Qlty, with isoclines representing equal values of overall SDE. Or we may plot no. visits x no. fruits/visit, with isoclines representing the overall Qty component. Isoclines just plot the values of the product of two variables. The code is the following:</p>

<p>You can install the last version of the R package directly with:</p>

<pre><code class="r">
# Installation.
devtools::install_github("pedroj/effectiveness_pckg")
library(effect.lndscp)
</code></pre>

<p>This is the skeleton for the function code. Please see the example datasets included in the package.</p>
<pre><code class="r">
# Example datasets.
data(prunus)
data(cecropia)
</code></pre>

<pre><code class="r">
#' Function to plot effectiveness landscapes, with repel labels option.
#' 
#' @import ggplot2
#' @import ggrepel
#' @importFrom classInt classIntervals
#' 
#' @param q1 Numeric vector representing the "quantitative component", to plot on the X axis. 
#' @param q2 Numeric vector representing the "qualitative component", to plot on the Y axis.
#' @param q1.error Optional. Numeric vector to be used as error bars for \code{q1}.
#' @param q2.error Optional. Numeric vector to be used as error bars for \code{q2}.
#' @param pts.shape Optional. A grouping variable (< 7 groups) to set point shapes (e.g., family).
#' @param pts.color Optional. A grouping variable to set point colours (e.g., family).
#' @param pts.size Optional. Size of points.
#' @param label Optional. A character vector of the same length as \code{q1} and \code{q2} providing a label for the individual points (e.g., species acronym). Note that \code{label} may be NA for some points (useful to avoid overplotting of labels).
#' @param label.size Size of point labels.
#' @param italic Logical. Use italic font for labels? 
#' @param show.lines Logical. Show effectiveness isolines? (default is TRUE).
#' @param nlines Specify the number of isolines.
#' @param lines.breaks Either a numeric vector giving break points for the contour lines, or a \code{"style"} (e.g. \code{"quantile"}, \code{"equal"}, or \code{"pretty"}) to choose optimal breaks using \code{\link[classInt]{classIntervals}}. Note that using "pretty" will override \code{nlines}, as the number of lines will be determined algorithmically. See \code{\link[classInt]{classIntervals}} for more details.
#' @param lines.color Color of the isolines.
#' @param myxlab optional label for axis X.
#' @param myylab optional label for axis Y.
#' @param ... Further arguments to be passed to \code{\link[ggrepel]{geom_text_repel}} (apart from \code{segment_size}, \code{segment_alpha}, and \code{fontface}, which are already defined in this function).
#'
#' @details The script plots effectiveness landscapes as described in Schupp, E. W., Jordano, P. and Gómez, J.M. 2010. Seed dispersal effectiveness revisited: a conceptual review. New Phytologist 188: 333-353.
#' 
#' @return A ggplot2 object, which can be later modified (see examples).
#' @export
#'
#' @examples
#' #------------------------------------------------------------------------
#' # Based on a dataset of Cecropia glaziovii frugivores.
#' # In this example we build the effectiveness landscape just for the 
#' # quantitative component, plotting its two subcomponents, visitation 
#' # rate and per-visit effectiveness.
#' #------------------------------------------------------------------------
#' data(cecropia)
#' effectiveness_plot(q1 = cecropia$totvis, q2 = cecropia$totbic, 
#'     myxlab= "No. visits/10h", 
#'     myylab="Effectiveness/vis (No. fruits handled)")
#' #------------------------------------------------------------------------
#' 
#' ## Avoiding label overplotting ##
#' ## e.g. showing only names of species with high effectiveness
#' labels = cecropia$code
#' labels[4:length(cecropia$code)] <- NA
#' effectiveness_plot(q1 = cecropia$totvis, q2 = cecropia$totbic, 
#'     label = labels, 
#'     myxlab= "No. visits/10h", 
#'     myylab="Effectiveness/vis (No. fruits handled)")
#'     
#'     
#' ################################################
#' 
#' ## Modify plot ##
#' myplot <- effectiveness_plot(q1 = cecropia$totvis, q2 = cecropia$totbic, 
#'     label = labels, nlines = 10, 
#'     myxlab= "No. visits/10h", 
#'     myylab="Effectiveness/vis (No. fruits handled)")
#' myplot + ggplot2::theme_minimal()
#' 
#'
effectiveness_plot <- function(q1, q2, 
                               q1.error = NULL, q2.error = NULL, 
                               pts.shape = NULL, pts.color = NULL, pts.size = 2,
                               label = NA, label.size = 3, italic = FALSE, 
                               show.lines = TRUE, nlines = 6,
                               lines.breaks = "quantile", lines.color = "grey50", 
                               myxlab= "QtComp", myylab= "QltComp", ...)    {

    
    ## Some checks before starting the work...
    
    if (length(q1) != length(q2)) stop("q1 and q2 must have equal length")
    

    
    ### General elements ###
    
    d <- data.frame(x = q1, y = q2, label = label)  
    
    effplot <- 
        ggplot(data = d, aes(x, y)) + 
        mytheme_bw() +
        labs(x = myxlab, y = myylab) +
        theme(legend.title = element_blank())
    
    
    
    ##### Plotting contour lines ####
    
    if (show.lines) {
        
        ### Fabricate contour lines ###
        
        ## Define lower and upper bounds ##
        x.lower <- ifelse(is.null(q1.error), 0, min(0, q1 - q1.error, na.rm = TRUE))
        x.upper <- ifelse(is.null(q1.error), max(q1), max(q1, q1 + q1.error, na.rm = TRUE))
        y.lower <- ifelse(is.null(q2.error), 0, min(0, q2 - q2.error, na.rm = TRUE))
        y.upper <- ifelse(is.null(q2.error), max(q2), max(q2, q2 + q2.error, na.rm = TRUE))
        
        ## Calculate values ##
        df <- expand.grid(x = seq(x.lower - 0.05*x.lower, x.upper + 0.05*x.upper, length.out = 500),
                          y = seq(y.lower - 0.05*y.lower, y.upper + 0.05*y.upper, length.out = 500))
        df$z <- df$x * df$y
        
        ## Define line breaks ##
        ## If not provided, using classIntervals to get nice breaks:
        ## e.g. style = "pretty" give nice rounded numbers for breaks (often ignoring nlines)
        ## style = "quantile" cover better the plot, but values are not rounded (uglier)
        ## there are other alternatives, see ?classIntervals
        
        if (is.numeric(lines.breaks)) {
            if (length(lines.breaks) != (nlines + 1)) stop("Length of lines.breaks does not match the specified number of lines (nlines + 1)")
            lbreaks <- lines.breaks
        }
        
        if (is.character(lines.breaks)) {
            lbreaks <- classInt::classIntervals(df$z, n = nlines + 1, 
                                                style = lines.breaks)$brks
        }
        
        
        #### Preparing curve labels ####
        brk <- lbreaks[-c(1, length(lbreaks))]
        xlabel <- rep(max(df$x) + 0.05*max(df$x), times = length(brk))
        ylabel <- brk/xlabel
        # trying pretty labels:
        if (is.numeric(lines.breaks)) lines.labels <- as.character(brk) else
            lines.labels <- ifelse(brk > 10, as.character(round(brk)), 
                                   as.character(signif(brk, digits = 2)))
        xy.labels <- data.frame(x = xlabel, y = ylabel, label = lines.labels)
        xy.labels <- subset(xy.labels, y > y.lower)
        
        
        ### Add lines to plot ###
        effplot <- effplot +
            geom_contour(aes(x, y, z = z), data = df, colour = lines.color, breaks = lbreaks, size = 0.3) + 
            geom_text(aes(x, y, label = label), data = xy.labels)
        
        
    } 
    
    
        ### Error bars ###
    
    if (!is.null(q1.error)) {
        
        d <- data.frame(d, x.error = q1.error)
        #d$x.error[is.na(d$x.error)] <- 0
        effplot <- effplot + 
            geom_errorbarh(aes(xmin = x - x.error, xmax = x + x.error), data = d)
    }
    
    if (!is.null(q2.error)) {
        
        d <- data.frame(d, y.error = q2.error)
        #d$y.error[is.na(d$y.error)] <- 0
        effplot <- effplot + 
            geom_errorbar(aes(ymin = y - y.error, ymax = y + y.error), data = d)
    }
    
    ### Draw points ###
    
    if (is.null(pts.color) & is.null(pts.shape)) {
        effplot <- effplot +
            geom_point(size = pts.size)
    }
    
    if (is.null(pts.color) & !is.null(pts.shape)) {
        d <- data.frame(d, pts.shape)
        effplot <- effplot +
            geom_point(aes(shape = pts.shape), data = d, size = pts.size)
    }
    
    if (!is.null(pts.color) & is.null(pts.shape)) {
        d <- data.frame(d, pts.color)
        effplot <- effplot +
            geom_point(aes(colour = pts.color), data = d, size = pts.size)
    }
    
    if (!is.null(pts.color) & !is.null(pts.shape)) {
        d <- data.frame(d, pts.shape, pts.color)
        effplot <- effplot +
            geom_point(aes(color = pts.color, shape = pts.shape), 
                       data = d, size = pts.size)
    }
    
        

    ### Add point labels with ggrepel ###
    
    if (any(!is.na(label))) {
        
        effplot <- effplot +
            geom_text_repel(aes(x, y), data = d, size = label.size, label = label, 
                           # nudge_y = 0.5, 
                            segment.size = 0.2, segment.alpha = 0.75,
                            fontface = ifelse(isTRUE(italic), "italic", "plain"),
                           ...) 
    }
    
    
    ## Print and return ggplot object
    effplot
    
}
</code></pre>


<h2>Example</h2>

<p>To do the SDE or PE plot, let's use an example:
We use the actual values obtained for the seed dispersal of <i>Prunus mahaleb</i> and . We were interested in plotting the locations of the different species of frugivores visiting the tree for fruit food and dispersing its seeds, and visualize them on the PE landscape. </p>

<p>The function overlays the isolines automatically. You can set the number of desired isolines. </p>

<p>Here is an example run. You can get the whole RMarkdown file in <a href="https://github.com/pedroj/effectiveness">my GitHub repository for the effectiveness landscapes code in R</a>. The whole run of the example is <a href="http://htmlpreview.github.io/?https://raw.github.com/Pakillo/R-figures/blob/master/Networks/effectiveness.html">here</a>.</p>

<pre><code class="r">
# Installation.
devtools::install_github("pedroj/effectiveness_pckg")
library(effect.lndscp)

#--------------------------------------------------------------------
# Based on a dataset of Prunus mahaleb frugivores.
# In this example we build the effectiveness landscape just for the 
# quantitative component, plotting its two subcomponents, visitation 
# rate and per-visit effectiveness.
#

data(prunus)
effectiveness_plot(prunus$visits, prunus$eff_per_vis, 
   pts.shape = prunus$group, label = prunus$animal,  
   myxlab = "No. visits/10h", 
   myylab = "Effectiveness/vis (No. fruits handled)")
#--------------------------------------------------------------------
# Based on a dataset of Cecropia glaziovii frugivores.
# This effectiveness_plot function has repel labels activated.
data(cecropia)
effectiveness_plot(cecropia$totvis, cecropia$totbic, 
    cecropia$fam, cecropia$code, 10, 
    myxlab= "No. visits/10h", 
    myylab="Effectiveness/vis (No. fruits handled)")

</code></pre>

<p>The function returns a ggplot2 plot object that can be later customized with additional ggplot2 options, as well as the actual plot. </p>

<h2>Suggested references:</h2>

<ul>
<li>Schupp, E.W., Jordano, P. &amp; Gomez, J.M. (2017). A general framework for effectiveness concepts in mutualisms. Ecology Letters, 20, 577–590. doi: 10.1111/ele.12764</li>
<li>Schupp, E.W. (1993). Quantity, quality and the effectiveness of seed dispersal by animals. Vegetatio, 108, 15–29.</li>
<li>Schupp, E.W., Jordano, P. &amp; Gomez, J.M. (2010). Seed dispersal effectiveness revisited: a conceptual review. New Phytologist, 188, 333–353.</li>
<li>Jordano, P. &amp; Schupp, E. (2000). Seed disperser effectiveness: The quantity component and patterns of seed rain for Prunus mahaleb. Ecological Monographs, 70, 591–615.</li>
</ul>

</section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>


